{% extends "base.html" %}

{% block title %}Resultados - Extrator de PDF{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-file-earmark-check"></i>
                    Resultados da Extração
                </h2>
                <p class="text-muted mb-0">Arquivo: <strong>{{ job.filename }}</strong></p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i>
                    Processar Novo Arquivo
                </a>
            </div>
        </div>

        {% if job.status == 'completed' %}
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="bi bi-list-ol text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.total_registros }}</h4>
                        <p class="text-muted mb-0">Total de Registros</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-car-front text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.placas_unicas }}</h4>
                        <p class="text-muted mb-0">Placas Únicas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.registros_com_data }}</h4>
                        <p class="text-muted mb-0">Com Data</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-currency-dollar text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">R$ {{ format_currency_br(job.stats.valor_total) }}</h4>
                        <p class="text-muted mb-0">Valor Total</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download"></i>
                    Downloads
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='excel') }}" 
                           class="btn btn-success w-100">
                            <i class="bi bi-file-earmark-excel"></i>
                            Baixar Excel (.xlsx)
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='csv') }}" 
                           class="btn btn-info w-100">
                            <i class="bi bi-filetype-csv"></i>
                            Baixar CSV (.csv)
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='both') }}" 
                           class="btn btn-primary w-100">
                            <i class="bi bi-file-zip"></i>
                            Baixar Ambos (.zip)
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table"></i>
                    Dados Extraídos
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="dataTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-car-front"></i> Placa</th>
                                <th><i class="bi bi-calendar"></i> Data</th>
                                <th><i class="bi bi-currency-dollar"></i> Total</th>
                                <th><i class="bi bi-file-text"></i> Texto Original</th>
                                <th><i class="bi bi-file"></i> Página</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in job.data %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ item.placa }}</span>
                                </td>
                                <td>{{ item.data }}</td>
                                <td>
                                    <span class="text-success fw-bold">R$ {{ item.total }}</span>
                                </td>
                                <td>
                                    <span class="text-muted small">{{ item.texto_original[:100] }}{% if item.texto_original|length > 100 %}...{% endif %}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.pagina }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif job.status == 'error' %}
        <!-- Error State -->
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-exclamation-triangle"></i>
                Erro no Processamento
            </h4>
            <p>{{ job.message }}</p>
            <hr>
            <p class="mb-0">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i>
                    Tentar Novamente
                </a>
            </p>
        </div>

        {% else %}
        <!-- Processing State -->
        <div id="processing-container" class="text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Processando...</span>
            </div>
            <h4 id="processing-title">Processando arquivo...</h4>
            <p id="processing-message" class="text-muted">{{ job.message }}</p>
            
            <div class="progress mt-3" style="max-width: 500px; margin: 0 auto;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Extraindo dados do PDF e organizando por placa e data...
                </small>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    {% if job.status == 'completed' %}
    // Inicializa DataTable
    $('#dataTable').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
        },
        pageLength: 25,
        order: [[1, 'desc']], // Ordena por data desc
        columnDefs: [
            {
                targets: [3], // Coluna do texto original
                render: function(data, type, row) {
                    if (type === 'display' && data.length > 100) {
                        return '<span title="' + data + '">' + data.substr(0, 100) + '...</span>';
                    }
                    return data;
                }
            }
        ],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
    {% elif job.status == 'processing' %}
    let pollCount = 0;
    let progressValue = 25;
    
    // Atualiza a barra de progresso gradualmente
    function updateProgress() {
        progressValue = Math.min(progressValue + 5, 90);
        $('#progress-bar').css('width', progressValue + '%').attr('aria-valuenow', progressValue);
    }
    
    // Inicia o processamento via AJAX
    console.log('Iniciando processamento do job {{ job.id }}');
    $('#processing-message').text('Iniciando processamento...');
    
    $.post('/api/process/{{ job.id }}')
        .done(function(response) {
            console.log('Processamento iniciado com sucesso:', response);
            $('#processing-message').text('Extraindo dados do PDF...');
            updateProgress();
        })
        .fail(function(xhr) {
            console.error('Erro ao iniciar processamento:', xhr.responseJSON);
            $('#processing-title').text('Erro ao iniciar processamento');
            $('#processing-message').text('Erro: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Erro desconhecido'));
        });
    
    // Polling para verificar status
    function checkJobStatus() {
        pollCount++;
        console.log('Verificando status do job (tentativa ' + pollCount + ')...');
        
        $.get('/api/job/{{ job.id }}')
            .done(function(response) {
                console.log('Status atual:', response);
                
                if (response.status === 'completed') {
                    console.log('Processamento concluído! Recarregando página...');
                    $('#processing-title').text('Processamento concluído!');
                    $('#processing-message').text('Redirecionando para resultados...');
                    $('#progress-bar').css('width', '100%').attr('aria-valuenow', 100);
                    
                    // Espera um pouco antes de recarregar para mostrar o feedback
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else if (response.status === 'error') {
                    console.error('Erro no processamento:', response.message);
                    $('#processing-title').text('Erro no Processamento');
                    $('#processing-message').text(response.message);
                    $('#progress-bar').removeClass('progress-bar-animated').addClass('bg-danger');
                } else {
                    // Ainda processando
                    if (response.message) {
                        $('#processing-message').text(response.message);
                    }
                    updateProgress();
                    
                    // Continua verificando a cada 2 segundos
                    setTimeout(checkJobStatus, 2000);
                }
            })
            .fail(function(xhr) {
                console.error('Erro ao verificar status do job:', xhr);
                
                if (pollCount <= 10) {
                    // Retry até 10 vezes
                    $('#processing-message').text('Verificando status... (tentativa ' + pollCount + ')');
                    setTimeout(checkJobStatus, 3000);
                } else {
                    $('#processing-title').text('Erro de Comunicação');
                    $('#processing-message').text('Não foi possível verificar o status do processamento.');
                    $('#progress-bar').removeClass('progress-bar-animated').addClass('bg-warning');
                }
            });
    }
    
    // Inicia o polling após 3 segundos
    setTimeout(checkJobStatus, 3000);
    
    // Atualiza progresso visual a cada segundo
    setInterval(function() {
        if (progressValue < 90) {
            updateProgress();
        }
    }, 1000);
    {% endif %}
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Resultados - Extrator de PDF{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-file-earmark-check"></i>
                    Resultados da Extração
                </h2>
                <p class="text-muted mb-0">Arquivo: <strong>{{ job.filename }}</strong></p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i>
                    Processar Novo Arquivo
                </a>
            </div>
        </div>

        {% if job.status == 'completed' %}
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="bi bi-list-ol text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.total_registros }}</h4>
                        <p class="text-muted mb-0">Total de Registros</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-car-front text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.placas_unicas }}</h4>
                        <p class="text-muted mb-0">Placas Únicas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">{{ job.stats.registros_com_data }}</h4>
                        <p class="text-muted mb-0">Com Data</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-currency-dollar text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1">R$ {{ format_currency_br(job.stats.valor_total) }}</h4>
                        <p class="text-muted mb-0">Valor Total</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download"></i>
                    Downloads
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='excel') }}" 
                           class="btn btn-success w-100">
                            <i class="bi bi-file-earmark-excel"></i>
                            Baixar Excel (.xlsx)
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='csv') }}" 
                           class="btn btn-info w-100">
                            <i class="bi bi-filetype-csv"></i>
                            Baixar CSV (.csv)
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('download_file', job_id=job.id, file_type='both') }}" 
                           class="btn btn-primary w-100">
                            <i class="bi bi-file-zip"></i>
                            Baixar Ambos (.zip)
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table"></i>
                    Dados Extraídos
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="dataTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-car-front"></i> Placa</th>
                                <th><i class="bi bi-calendar"></i> Data</th>
                                <th><i class="bi bi-currency-dollar"></i> Total</th>
                                <th><i class="bi bi-file-text"></i> Texto Original</th>
                                <th><i class="bi bi-file"></i> Página</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in job.data %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ item.placa }}</span>
                                </td>
                                <td>{{ item.data }}</td>
                                <td>
                                    <span class="text-success fw-bold">R$ {{ item.total }}</span>
                                </td>
                                <td>
                                    <span class="text-muted small">{{ item.texto_original[:100] }}{% if item.texto_original|length > 100 %}...{% endif %}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.pagina }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif job.status == 'error' %}
        <!-- Error State -->
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-exclamation-triangle"></i>
                Erro no Processamento
            </h4>
            <p>{{ job.message }}</p>
            <hr>
            <p class="mb-0">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i>
                    Tentar Novamente
                </a>
            </p>
        </div>

        {% else %}
        <!-- Processing State -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Processando...</span>
            </div>
            <h4>Processando arquivo...</h4>
            <p class="text-muted">{{ job.message }}</p>
            
            <div class="progress mt-3" style="max-width: 500px; margin: 0 auto;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 75%"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    {% if job.status == 'completed' %}
    // Inicializa DataTable
    $('#dataTable').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
        },
        pageLength: 25,
        order: [[1, 'desc']], // Ordena por data desc
        columnDefs: [
            {
                targets: [3], // Coluna do texto original
                render: function(data, type, row) {
                    if (type === 'display' && data.length > 100) {
                        return '<span title="' + data + '">' + data.substr(0, 100) + '...</span>';
                    }
                    return data;
                }
            }
        ],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
    {% endif %}
    
    {% if job.status == 'processing' %}
    // Auto-refresh para jobs em processamento
    setTimeout(function() {
        location.reload();
    }, 3000);
    {% endif %}
});
</script>
{% endblock %}
